# SPDX-FileCopyrightText: 2023 Univention GmbH
# SPDX-License-Identifier: AGPL-3.0-only
---
- name: "Global: Read and parse config.yaml"
  ansible.builtin.set_fact:
    global_cfgobj: "{{ lookup('file', '/app/values.yaml') | from_yaml }}"

- name: "Global: Set variables"
  ansible.builtin.set_fact:
    global_admin_username: "{{ global_cfgobj.config.keycloak.adminUser }}"
    global_admin_password: "{{ global_cfgobj.config.keycloak.adminPassword }}"
    global_keycloak_host: "{{ global_cfgobj.global.hosts.keycloak }}.{{ global_cfgobj.global.domain }}"
    global_ums_realm: "{{ global_cfgobj.config.keycloak.realm }}"

- name: "Global: Set derived variable for external connection"
  ansible.builtin.set_fact:
    global_keycloak_url: "https://{{ global_keycloak_host }}"
  when: "not global_cfgobj.config.keycloak.intraCluster.enabled"

- name: "Global: Set derived variable for internal connection"
  ansible.builtin.set_fact:
    global_keycloak_url: "{{ global_cfgobj.config.keycloak.intraCluster.internalBaseUrl }}"
  when: "global_cfgobj.config.keycloak.intraCluster.enabled"

- name: "Set global access token"
  ansible.builtin.include_tasks: "../ansible-shared/set_global_accesstoken.yml"
...
